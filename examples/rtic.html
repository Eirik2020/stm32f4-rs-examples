<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>RTIC - Embedded Rust on the STM32F4 for dummies</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Embedded Rust on the STM32F4 for dummies</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rtic"><a class="header" href="#rtic">RTIC</a></h1>
<p>So far, we have only used blocking logic. Meaning, we only do one thing at a time. So for example when we blink our LED, we rush over to the light switch and flip it, then religiously wait for one second. Meaning we do nothing while we wait, which seems like a waste doesn't it?</p>
<p>Well, RTIC is here to save the day! Now we can boost our productivity by 1000^10%! Think about all the things you could do while waiting, like cleaning your room <em>side-eye</em>.</p>
<p>To use RTIC, we will need a couple more crates:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use rtt_target::{rprintln, rtt_init_print};
use panic_rtt_target as _;
use rtic::app;
use rtic_monotonics::systick::prelude::*;
<span class="boring">}</span></code></pre></pre>
<ul>
<li><code>use rtt_target::{rprintln, rtt_init_print};</code> - Imports the Real-Time Transfer (RTT) interface.
<ul>
<li><code>rtt_init_print</code> - Print line macro that works of RTT.</li>
<li><code>rprintln</code> - Used to initialize RTT.</li>
</ul>
</li>
<li><code>use panic_rtt_target as _;</code> - Imports panic handler for RTT.</li>
<li><code>use rtic::app;;</code> - Imports the RTIC app.</li>
<li><code>use rtic_monotonics::systick::prelude::*;</code> - Imports monotonic timer.</li>
</ul>
<p>What is a monotonic timer? I am glad you asked! It it our reference used to schedule tasks and set delays. In the example below, we make a timer running at 1000 Hz, which equals about 1 ms resolution. Allowing us to schedule in milliseconds.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>systick_monotonic!(Mono, 1000); // 1000 Hz
<span class="boring">}</span></code></pre></pre>
<p>Next, we will have a look at the structure of a RTIC app:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[app(
    device = stm32f4xx_hal::pac,  // This device uses the stm32f4xx_hal Peripheral Access Crate (PAC).
    peripherals = true,           // Auto-initializes the Peripherals struct (dp).
    dispatchers = [SPI1],         // Unused interrupts that RTIC can use internally for software tasks, in this case SPI1. 
)]
mod app {
    // Import everything (*) from the parent module (rtic_blinky.rs)
    use super::*;

    // Resources
    #[shared] // Shared between different tasks
    struct Shared {}

    #[local] // Task local data only
    struct Local {}


    #[init] // Start-up function that initializes the program.
    fn init(cx: init::Context) -&gt; (Shared, Local) {
        (...)
        (Shared {}, Local {})
    }
}
<span class="boring">}</span></code></pre></pre>
<p>The first part of our structure has the <code>#[app()]</code>. It contains the configuration for our RTIC app, like which device we are using (STM32F4), if we want to auto-initialize our peripherals (<code>peripherals</code>) and which interrupts (<code>SPI1</code>) are free for the app to use (<code>dispatchers</code>).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[app(
    device = stm32f4xx_hal::pac,  
    peripherals = true,           
    dispatchers = [SPI1],         
)]
<span class="boring">}</span></code></pre></pre>
<p>Next, we have the app body.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod app {
    use super::*;

    #[shared]
    struct Shared {}

    #[local]
    struct Local {}

    #[init] 
    fn init(cx: init::Context) -&gt; (Shared, Local) {
        (...)
        (Shared {}, Local {})
    }
}
<span class="boring">}</span></code></pre></pre>
<p>The first line <code>use super::*;</code>, simply brings all (<code>*</code>) the imports from the module (<code>your_code.rs</code>) into the app.</p>
<p>Next, we have the resources avaiable in the app, think variables, data structures etc.</p>
<ul>
<li>The shared struct (<code>struct Shared {}</code>), contains resources shared between tasks, like sensor readings.</li>
<li>The local struct (<code>struct Local {}</code>), contains local data only used within a task, and is NOT shared between structs.</li>
</ul>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[shared]
struct Shared {}

#[local]
struct Local {}
<span class="boring">}</span></code></pre></pre>
<p>Lastly we have the <code>init</code> function. This functions initializes our program and kicks it off. We need it since we don't have a main loop anymore.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[init] 
fn init(cx: init::Context) -&gt; (Shared, Local) {
    (...)
    (Shared {}, Local {})
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>init</code> function takes our <code>Local</code> and <code>Shared</code> struct, and puts it into the context struct <code>cx</code>.<br />
It also allows us to initialize our resources:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>(Shared {}, Local {})
<span class="boring">}</span></code></pre></pre>
<p>In addition, we have tasks <code>#[task()]</code>. We use these to perform actions, like blinking a LED, reading a UART message or setting the duty cycle for PWM.
A task may look like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span> #[task(local = [led, state])] // This task uses the local resources "led" and "state".
    async fn blink(cx: blink::Context) { // Use context cx to access local and shared resources.
        loop {
            rprintln!("blink");
            // Access local resources from context (cx.local)
            if *cx.local.state {         // If LED is on.
                cx.local.led.set_high();
                *cx.local.state = false;
            } else {                     // If LED is off
                cx.local.led.set_low();
                *cx.local.state = true;
            }
            // At the end of the task, wait 1000 ms (none-blocking).
            Mono::delay(1000.millis()).await;
        }
    }
<span class="boring">}</span></code></pre></pre>
<ul>
<li><code>#[task(local = [led, state])]</code> - Here the task uses the <code>led</code> and <code>state</code> resources from the local resources struct <code>Local</code>.</li>
<li><code>#async fn blink(cx: blink::Context)</code> - We declare it as a async function (always required in RTIC V2), and access the resources and peripherals through context(<code>cx</code>).</li>
</ul>
<p>The loop operates similarlly as we have done before, but we now access the LED and its state through the <code>cx.local</code> struct.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>loop {
    rprintln!("blink");
    // Access local resources from context (cx.local)
    if *cx.local.state {         // If LED is on.
        cx.local.led.set_high();
        *cx.local.state = false;
        ...
    }
}
<span class="boring">}</span></code></pre></pre>
<p>Finally at the end, we make use of our monotonic timer:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>Mono::delay(1000.millis()).await;
<span class="boring">}</span></code></pre></pre>
<p>As opposed to our old delay, this delay will not block the CPU, allowing it to do other tasks in the background while the <code>blink</code> task is waiting.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../examples/uart/uart_menu.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../examples/rtic/rtic_LED.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../examples/uart/uart_menu.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../examples/rtic/rtic_LED.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
